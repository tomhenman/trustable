openapi: 3.0.3
info:
  title: Trustable Brands API
  description: |
    API for managing brands, competitors, and prompt sets.
    This is the entry point for all brand-related data in Trustable.
    
    ## Implementation Note
    
    **These endpoints are NOT Edge Functions.** They are documented here for 
    API contract purposes, but are implemented via **direct Supabase client** 
    operations with Row-Level Security (RLS).
    
    ### Lovable Integration
    
    Use the Supabase JS client directly:
    
    ```typescript
    // List brands
    const { data } = await supabase
      .from('businesses')
      .select('*')
      .order('created_at', { ascending: false });
    
    // Create brand
    const { data } = await supabase
      .from('businesses')
      .insert({ name: 'Acme Corp', category: 'Technology' })
      .select()
      .single();
    
    // Update brand
    const { data } = await supabase
      .from('businesses')
      .update({ name: 'New Name' })
      .eq('id', brandId)
      .select()
      .single();
    
    // Delete brand
    await supabase
      .from('businesses')
      .delete()
      .eq('id', brandId);
    ```
    
    RLS policies ensure users can only access their own brands.
  version: 1.0.0
  x-implementation: supabase-client
  x-table: businesses

servers:
  - url: https://{project}.supabase.co/functions/v1
    variables:
      project:
        default: your-project-ref

security:
  - bearerAuth: []

paths:
  /brands:
    get:
      operationId: listBrands
      summary: List all brands for the authenticated user's workspace
      description: |
        **Implementation:** Direct Supabase client query
        ```typescript
        supabase.from('businesses').select('*').order('created_at', { ascending: false })
        ```
      tags: [Brands]
      x-implementation: supabase-client
      x-table: businesses
      x-rls: user_id = auth.uid()
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
      responses:
        '200':
          description: List of brands
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Brand'
                  total:
                    type: integer

    post:
      operationId: createBrand
      summary: Create a new brand
      description: |
        **Implementation:** Direct Supabase client insert
        ```typescript
        supabase.from('businesses').insert({ ...body }).select().single()
        ```
      tags: [Brands]
      x-implementation: supabase-client
      x-table: businesses
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateBrandRequest'
      responses:
        '201':
          description: Brand created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Brand'
        '400':
          $ref: '#/components/responses/BadRequest'
        '403':
          $ref: '#/components/responses/PlanLimitExceeded'

  /brands/{brandId}:
    get:
      operationId: getBrand
      summary: Get a brand by ID
      description: |
        **Implementation:** Direct Supabase client query
        ```typescript
        supabase.from('businesses').select('*').eq('id', brandId).single()
        ```
      tags: [Brands]
      x-implementation: supabase-client
      x-table: businesses
      parameters:
        - $ref: '#/components/parameters/brandId'
      responses:
        '200':
          description: Brand details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Brand'
        '404':
          $ref: '#/components/responses/NotFound'

    patch:
      operationId: updateBrand
      summary: Update a brand
      description: |
        **Implementation:** Direct Supabase client update
        ```typescript
        supabase.from('businesses').update({ ...body }).eq('id', brandId).select().single()
        ```
      tags: [Brands]
      x-implementation: supabase-client
      x-table: businesses
      parameters:
        - $ref: '#/components/parameters/brandId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateBrandRequest'
      responses:
        '200':
          description: Brand updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Brand'

    delete:
      operationId: deleteBrand
      summary: Delete a brand
      description: |
        **Implementation:** Direct Supabase client delete
        ```typescript
        supabase.from('businesses').delete().eq('id', brandId)
        ```
        Note: Cascades to all related data (prompts, scans, scores, etc.)
      tags: [Brands]
      x-implementation: supabase-client
      x-table: businesses
      parameters:
        - $ref: '#/components/parameters/brandId'
      responses:
        '204':
          description: Brand deleted

  /brands/{brandId}/competitors:
    x-implementation-note: |
      Competitors are stored in the `businesses.competitors` array column.
      For detailed benchmarks, use the `competitor_benchmarks` table.
    get:
      operationId: listCompetitors
      summary: List competitors for a brand
      description: |
        **Implementation:** Direct Supabase client query
        ```typescript
        // Simple list from array column
        const { data } = await supabase
          .from('businesses')
          .select('competitors')
          .eq('id', brandId)
          .single();
        
        // With benchmark data
        const { data } = await supabase
          .from('competitor_benchmarks')
          .select('*')
          .eq('business_id', brandId);
        ```
      tags: [Competitors]
      x-implementation: supabase-client
      x-table: businesses, competitor_benchmarks
      parameters:
        - $ref: '#/components/parameters/brandId'
      responses:
        '200':
          description: List of competitors
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Competitor'

    post:
      operationId: addCompetitor
      summary: Add a competitor to track
      description: |
        **Implementation:** Direct Supabase client - append to array
        ```typescript
        // Add to competitors array
        const { data: business } = await supabase
          .from('businesses')
          .select('competitors')
          .eq('id', brandId)
          .single();
        
        await supabase
          .from('businesses')
          .update({ 
            competitors: [...(business.competitors || []), newCompetitor] 
          })
          .eq('id', brandId);
        ```
      tags: [Competitors]
      x-implementation: supabase-client
      x-table: businesses
      parameters:
        - $ref: '#/components/parameters/brandId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateCompetitorRequest'
      responses:
        '201':
          description: Competitor added
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Competitor'

  /brands/{brandId}/prompt-sets:
    x-implementation-note: |
      Prompt sets use the `tracked_prompts` and `prompt_groups` tables.
    get:
      operationId: listPromptSets
      summary: List prompt sets for a brand
      description: |
        **Implementation:** Direct Supabase client query
        ```typescript
        // Get prompt groups with prompts
        const { data } = await supabase
          .from('prompt_groups')
          .select('*, prompts:tracked_prompts(*)')
          .eq('business_id', brandId);
        
        // Or just prompts
        const { data } = await supabase
          .from('tracked_prompts')
          .select('*')
          .eq('business_id', brandId)
          .eq('is_active', true);
        ```
      tags: [Prompts]
      x-implementation: supabase-client
      x-table: prompt_groups, tracked_prompts
      parameters:
        - $ref: '#/components/parameters/brandId'
      responses:
        '200':
          description: List of prompt sets
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/PromptSet'

    post:
      operationId: createPromptSet
      summary: Create a new prompt set
      description: |
        **Implementation:** Direct Supabase client insert
        ```typescript
        // Create group
        const { data: group } = await supabase
          .from('prompt_groups')
          .insert({ 
            business_id: brandId, 
            name: 'My Prompts',
            intent_tag: 'brand' 
          })
          .select()
          .single();
        
        // Add prompts
        await supabase
          .from('tracked_prompts')
          .insert(
            prompts.map(p => ({
              business_id: brandId,
              group_id: group.id,
              prompt: p.query,
              query_type: p.intent || 'BRAND_DIRECT',
            }))
          );
        ```
      tags: [Prompts]
      x-implementation: supabase-client
      x-table: prompt_groups, tracked_prompts
      parameters:
        - $ref: '#/components/parameters/brandId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreatePromptSetRequest'
      responses:
        '201':
          description: Prompt set created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PromptSet'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  parameters:
    brandId:
      name: brandId
      in: path
      required: true
      schema:
        type: string
        format: uuid

  responses:
    BadRequest:
      description: Invalid request
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
    PlanLimitExceeded:
      description: Plan limit exceeded
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

  schemas:
    Brand:
      type: object
      properties:
        id:
          type: string
          format: uuid
        workspace_id:
          type: string
          format: uuid
        name:
          type: string
        category:
          type: string
        location:
          type: string
        service_area:
          type: array
          items:
            type: string
        website_url:
          type: string
          format: uri
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    CreateBrandRequest:
      type: object
      required: [name]
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 255
        category:
          type: string
        location:
          type: string
        service_area:
          type: array
          items:
            type: string
        website_url:
          type: string
          format: uri

    UpdateBrandRequest:
      type: object
      properties:
        name:
          type: string
        category:
          type: string
        location:
          type: string
        service_area:
          type: array
          items:
            type: string
        website_url:
          type: string
          format: uri

    Competitor:
      type: object
      properties:
        id:
          type: string
          format: uuid
        brand_id:
          type: string
          format: uuid
        name:
          type: string
        website_url:
          type: string
          format: uri
        created_at:
          type: string
          format: date-time

    CreateCompetitorRequest:
      type: object
      required: [name]
      properties:
        name:
          type: string
        website_url:
          type: string
          format: uri

    PromptSet:
      type: object
      properties:
        id:
          type: string
          format: uuid
        brand_id:
          type: string
          format: uuid
        name:
          type: string
        prompts:
          type: array
          items:
            type: object
            properties:
              query:
                type: string
              intent:
                type: string
        is_active:
          type: boolean
        created_at:
          type: string
          format: date-time

    CreatePromptSetRequest:
      type: object
      required: [name, prompts]
      properties:
        name:
          type: string
        prompts:
          type: array
          items:
            type: object
            properties:
              query:
                type: string
              intent:
                type: string

    Error:
      type: object
      properties:
        error:
          type: string
        code:
          type: string
        details:
          type: object
